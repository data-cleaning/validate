<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Availability and uniqueness | The Data Validation Cookbook</title>
  <meta name="description" content="Chapter 3 Availability and uniqueness | The Data Validation Cookbook" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Availability and uniqueness | The Data Validation Cookbook" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Availability and uniqueness | The Data Validation Cookbook" />
  
  
  

<meta name="author" content="Mark P.J. van der Loo" />


<meta name="date" content="2020-11-23" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="sect-varlevelchecks.html"/>
<link rel="next" href="multivariate-checks.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Data Validation Cookbook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#citing-this-work"><i class="fa fa-check"></i>Citing this work</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction to validate</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-quick-example"><i class="fa fa-check"></i><b>1.1</b> A quick example</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html"><i class="fa fa-check"></i><b>2</b> Variable checks</a><ul>
<li class="chapter" data-level="" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#data-and-packages"><i class="fa fa-check"></i>Data and packages</a></li>
<li class="chapter" data-level="2.1" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#variable-type"><i class="fa fa-check"></i><b>2.1</b> Variable type</a></li>
<li class="chapter" data-level="2.2" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#sect:missingness"><i class="fa fa-check"></i><b>2.2</b> Missingness</a></li>
<li class="chapter" data-level="2.3" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#field-length"><i class="fa fa-check"></i><b>2.3</b> Field length</a></li>
<li class="chapter" data-level="2.4" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#format-of-numeric-fields"><i class="fa fa-check"></i><b>2.4</b> Format of numeric fields</a></li>
<li class="chapter" data-level="2.5" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#general-field-format"><i class="fa fa-check"></i><b>2.5</b> General field format</a></li>
<li class="chapter" data-level="2.6" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#numeric-ranges"><i class="fa fa-check"></i><b>2.6</b> Numeric ranges</a></li>
<li class="chapter" data-level="2.7" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#ranges-for-times-and-periods"><i class="fa fa-check"></i><b>2.7</b> Ranges for times and periods</a></li>
<li class="chapter" data-level="2.8" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#code-lists"><i class="fa fa-check"></i><b>2.8</b> Code lists</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sect-availableunique.html"><a href="sect-availableunique.html"><i class="fa fa-check"></i><b>3</b> Availability and uniqueness</a><ul>
<li class="chapter" data-level="" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#data-and-packages"><i class="fa fa-check"></i>Data and packages</a></li>
<li class="chapter" data-level="3.1" data-path="sect-availableunique.html"><a href="sect-availableunique.html#long-data"><i class="fa fa-check"></i><b>3.1</b> Long data</a></li>
<li class="chapter" data-level="3.2" data-path="sect-availableunique.html"><a href="sect-availableunique.html#sect:uniqueness"><i class="fa fa-check"></i><b>3.2</b> Uniqueness</a></li>
<li class="chapter" data-level="3.3" data-path="sect-availableunique.html"><a href="sect-availableunique.html#sect:completeness"><i class="fa fa-check"></i><b>3.3</b> Availability of records</a></li>
<li class="chapter" data-level="3.4" data-path="sect-availableunique.html"><a href="sect-availableunique.html#gaps-in-time-series"><i class="fa fa-check"></i><b>3.4</b> Gaps in (time) series</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="multivariate-checks.html"><a href="multivariate-checks.html"><i class="fa fa-check"></i><b>4</b> Multivariate checks</a><ul>
<li class="chapter" data-level="" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#data-and-packages"><i class="fa fa-check"></i>Data and packages</a></li>
<li class="chapter" data-level="4.1" data-path="multivariate-checks.html"><a href="multivariate-checks.html#sect:iscomplete"><i class="fa fa-check"></i><b>4.1</b> Completeness of records</a></li>
<li class="chapter" data-level="4.2" data-path="multivariate-checks.html"><a href="multivariate-checks.html#balance-equalities-and-inequalities"><i class="fa fa-check"></i><b>4.2</b> Balance equalities and inequalities</a></li>
<li class="chapter" data-level="4.3" data-path="multivariate-checks.html"><a href="multivariate-checks.html#conditional-restrictions"><i class="fa fa-check"></i><b>4.3</b> Conditional restrictions</a></li>
<li class="chapter" data-level="4.4" data-path="multivariate-checks.html"><a href="multivariate-checks.html#forbidden-value-combinations"><i class="fa fa-check"></i><b>4.4</b> Forbidden value combinations</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="sect-statisticalchecks.html"><a href="sect-statisticalchecks.html"><i class="fa fa-check"></i><b>5</b> Statistical checks</a><ul>
<li class="chapter" data-level="" data-path="sect-varlevelchecks.html"><a href="sect-varlevelchecks.html#data-and-packages"><i class="fa fa-check"></i>Data and packages</a></li>
<li class="chapter" data-level="5.1" data-path="sect-statisticalchecks.html"><a href="sect-statisticalchecks.html#sect:groupwise"><i class="fa fa-check"></i><b>5.1</b> Statistical and groupwise characteristics</a></li>
<li class="chapter" data-level="5.2" data-path="sect-statisticalchecks.html"><a href="sect-statisticalchecks.html#group-properties"><i class="fa fa-check"></i><b>5.2</b> Group properties</a></li>
<li class="chapter" data-level="5.3" data-path="sect-statisticalchecks.html"><a href="sect-statisticalchecks.html#code-hierarchies-and-aggregation"><i class="fa fa-check"></i><b>5.3</b> Code hierarchies and aggregation</a></li>
<li class="chapter" data-level="5.4" data-path="sect-statisticalchecks.html"><a href="sect-statisticalchecks.html#general-aggregates-in-long-form-data"><i class="fa fa-check"></i><b>5.4</b> General aggregates in long-form data</a><ul>
<li class="chapter" data-level="" data-path="sect-statisticalchecks.html"><a href="sect-statisticalchecks.html#notes"><i class="fa fa-check"></i>Notes</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="sect-statisticalchecks.html"><a href="sect-statisticalchecks.html#aggregates-of-time-series-in-long-format"><i class="fa fa-check"></i><b>5.5</b> Aggregates of time series in long format</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="indicators.html"><a href="indicators.html"><i class="fa fa-check"></i><b>6</b> Indicators</a><ul>
<li class="chapter" data-level="6.1" data-path="intro.html"><a href="intro.html#a-quick-example"><i class="fa fa-check"></i><b>6.1</b> A quick example</a></li>
<li class="chapter" data-level="6.2" data-path="indicators.html"><a href="indicators.html#getting-indicator-values"><i class="fa fa-check"></i><b>6.2</b> Getting indicator values</a></li>
<li class="chapter" data-level="6.3" data-path="indicators.html"><a href="indicators.html#compare"><i class="fa fa-check"></i><b>6.3</b> Compare</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="sect-work.html"><a href="sect-work.html"><i class="fa fa-check"></i><b>7</b> Working with validate</a><ul>
<li class="chapter" data-level="7.1" data-path="sect-work.html"><a href="sect-work.html#sect:readfromfile"><i class="fa fa-check"></i><b>7.1</b> Reading rules from file</a></li>
<li class="chapter" data-level="7.2" data-path="sect-work.html"><a href="sect-work.html#manipulating-rule-sets"><i class="fa fa-check"></i><b>7.2</b> Manipulating rule sets</a></li>
<li class="chapter" data-level="7.3" data-path="sect-work.html"><a href="sect-work.html#rule-metadata"><i class="fa fa-check"></i><b>7.3</b> Rule metadata</a></li>
<li class="chapter" data-level="7.4" data-path="sect-work.html"><a href="sect-work.html#sect:yamlfiles"><i class="fa fa-check"></i><b>7.4</b> Metadata in text files: <code>YAML</code></a></li>
<li class="chapter" data-level="7.5" data-path="sect-work.html"><a href="sect-work.html#rules-in-data-frames"><i class="fa fa-check"></i><b>7.5</b> Rules in data frames</a></li>
<li class="chapter" data-level="7.6" data-path="sect-work.html"><a href="sect-work.html#sect:syntax"><i class="fa fa-check"></i><b>7.6</b> Validation rule syntax</a></li>
<li class="chapter" data-level="7.7" data-path="sect-work.html"><a href="sect-work.html#confrontation-objects"><i class="fa fa-check"></i><b>7.7</b> Confrontation objects</a></li>
<li class="chapter" data-level="7.8" data-path="sect-work.html"><a href="sect-work.html#sect:options"><i class="fa fa-check"></i><b>7.8</b> Confrontation options</a></li>
<li class="chapter" data-level="7.9" data-path="sect-work.html"><a href="sect-work.html#using-reference-data"><i class="fa fa-check"></i><b>7.9</b> Using reference data</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="sect-rulefiles.html"><a href="sect-rulefiles.html"><i class="fa fa-check"></i><b>8</b> Rules in text files</a><ul>
<li class="chapter" data-level="8.1" data-path="sect-rulefiles.html"><a href="sect-rulefiles.html#setting-options"><i class="fa fa-check"></i><b>8.1</b> Setting options</a></li>
<li class="chapter" data-level="8.2" data-path="sect-rulefiles.html"><a href="sect-rulefiles.html#including-other-rule-files"><i class="fa fa-check"></i><b>8.2</b> Including other rule files</a></li>
<li class="chapter" data-level="8.3" data-path="sect-rulefiles.html"><a href="sect-rulefiles.html#exporting-validator-objects"><i class="fa fa-check"></i><b>8.3</b> Exporting validator objects</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="sect-comparing.html"><a href="sect-comparing.html"><i class="fa fa-check"></i><b>9</b> Comparing data sets</a><ul>
<li class="chapter" data-level="9.1" data-path="sect-comparing.html"><a href="sect-comparing.html#cell-counts"><i class="fa fa-check"></i><b>9.1</b> Cell counts</a></li>
<li class="chapter" data-level="9.2" data-path="sect-comparing.html"><a href="sect-comparing.html#comparing-rule-violations"><i class="fa fa-check"></i><b>9.2</b> Comparing rule violations</a></li>
<li class="chapter" data-level="9.3" data-path="sect-comparing.html"><a href="sect-comparing.html#validate-and-lumberjack"><i class="fa fa-check"></i><b>9.3</b> <code>validate</code> and <code>lumberjack</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="bibliographical-notes.html"><a href="bibliographical-notes.html"><i class="fa fa-check"></i>Bibliographical notes</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The Data Validation Cookbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sect:availableunique" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Availability and uniqueness</h1>
<p>In this Chapter it is demonstrated how to check whether records are available
and/or complete with respect to a set of keys, and whether they are unique.
The checks described here are typically useful for data in ‘long’ format, where
one column holds a value and all the other columns identify the value.</p>
<ul>
<li>To test for missing values in individual variables, see also <a href="sect-varlevelchecks.html#sect:missingness">2.2</a>.</li>
<li>To check whether records or parts thereof are completed, see <a href="multivariate-checks.html#sect:iscomplete">4.1</a>.</li>
</ul>
<div id="data-and-packages" class="section level3 unnumbered">
<h3>Data and packages</h3>
<p>In this Chapter the <code>samplonomy</code> dataset is used that comes with the <code>validate</code>
package.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" title="1"><span class="kw">library</span>(validate)</a>
<a class="sourceLine" id="cb62-2" title="2"><span class="kw">data</span>(samplonomy)</a>
<a class="sourceLine" id="cb62-3" title="3"><span class="kw">head</span>(samplonomy, <span class="dv">3</span>)</a></code></pre></div>
<pre><code>##   region freq period measure  value
## 1  Agria    A   2014     gdp 600000
## 2  Agria    A   2014  import 210000
## 3  Agria    A   2014  export 222000</code></pre>
</div>
<div id="long-data" class="section level2">
<h2><span class="header-section-number">3.1</span> Long data</h2>
<p>The samplonomy data set is structured in ‘long form’. This means that each
record has a single <code>value</code> column, and one or more columns containing
character values that together describe what the value means.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" title="1"><span class="kw">head</span>(samplonomy,<span class="dv">3</span>)</a></code></pre></div>
<pre><code>##   region freq period measure  value
## 1  Agria    A   2014     gdp 600000
## 2  Agria    A   2014  import 210000
## 3  Agria    A   2014  export 222000</code></pre>
<p>The data set contains several time series for multiple measures
of the fictional country ‘Samplonia’. There are time series for several
subregions of Samplonia.</p>
<p>Long format data is typically used as a transport format: it may be used to
bulk-load data into SQL-based data base systems, or to transfer data between
organisations in a unambiguous way.</p>
<p>Data in long form is in general much harder to check and process for
statistical purpose than data in wide format, where each variable is stored in
a separate column. The reason is that in long format relations between
different variables are spread out across records, and those records are not
necessarily ordered in any particular way prior to processing. This makes
interpretation of validation fails intrinsically harder for long-form data then
for wide-form data.</p>
<p>The <code>samplonomy</code> data set has a particularly nasty structure. It contains both
annual and quarterly time series for GDP, Import, Export and the Balance of
Trade (export less import). The period column therefore contains both quarterly
and annual labels. Furthermore, there are time series for the whole of
Samplonia (region Samplonia), for each of its two provinces (regions Agria and
Induston) and for each of its districts within Agria (Wheaton and Greenham) and
Induston (Smokeley, Mudwater, Newbay and Oakdale).</p>
<p>Naturally, we expect that the key combinations are unique, that all time series
are gapless and complete, that the Balance of trade equals Export less Import
everywhere, that district values add up to the provinces’, and that province
values add up to the total of Samplonia. Finally, the quarterly time series
must add up to the annual values.</p>
</div>
<div id="sect:uniqueness" class="section level2">
<h2><span class="header-section-number">3.2</span> Uniqueness</h2>
<p>The function <code>is_unique()</code> checks whether combinations of variables (usually
key variables) uniquely identify a record. It accepts any positive number of
variable names and returns <code>FALSE</code> for each record that is duplicated with
respect to the designated variariables.</p>
<p>Here, we test whether region, period, and measure uniquely identify a value in
the <code>samplonomy</code> data set.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" title="1">rule &lt;-<span class="st"> </span><span class="kw">validator</span>(<span class="kw">is_unique</span>(region, period, measure))</a>
<a class="sourceLine" id="cb66-2" title="2">out &lt;-<span class="st"> </span><span class="kw">confront</span>(samplonomy, rule)</a>
<a class="sourceLine" id="cb66-3" title="3"><span class="co"># showing 7 columns of output for readability</span></a>
<a class="sourceLine" id="cb66-4" title="4"><span class="kw">summary</span>(out)[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>]</a></code></pre></div>
<pre><code>##   name items passes fails nNA error warning
## 1   V1  1199   1197     2   0 FALSE   FALSE</code></pre>
<p>There are 2 fails. After extracting the individual
values for each record we can find the duplicated ones using a
convenience function from <code>validate</code>.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" title="1"><span class="kw">violating</span>(samplonomy, out)</a></code></pre></div>
<pre><code>##       region freq period measure  value
## 870 Induston    Q 2018Q2  export 165900
## 871 Induston    Q 2018Q2  export 170000</code></pre>
</div>
<div id="sect:completeness" class="section level2">
<h2><span class="header-section-number">3.3</span> Availability of records</h2>
<p>This section is on testing for availability of whole records. Testing for individual
missing values (NA), is treated in <a href="sect-varlevelchecks.html#sect:missingness">2.2</a>.</p>
<p>We wish to ensure that for each region, and each variable, the periods 2014,
2015, <span class="math inline">\(\ldots\)</span>, 2019 are present. Using <code>contains_at_least</code> we can establish
this.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" title="1">rule &lt;-<span class="st"> </span><span class="kw">validator</span>(</a>
<a class="sourceLine" id="cb70-2" title="2">  <span class="kw">contains_at_least</span>( <span class="dt">keys =</span> <span class="kw">data.frame</span>(<span class="dt">period =</span> <span class="kw">as.character</span>(<span class="dv">2014</span><span class="op">:</span><span class="dv">2019</span>))</a>
<a class="sourceLine" id="cb70-3" title="3">                    , <span class="dt">by=</span><span class="kw">list</span>(region, measure) )</a>
<a class="sourceLine" id="cb70-4" title="4">)</a>
<a class="sourceLine" id="cb70-5" title="5">out &lt;-<span class="st"> </span><span class="kw">confront</span>(samplonomy, rule)</a>
<a class="sourceLine" id="cb70-6" title="6"><span class="co"># showing 7 columns of output for readability</span></a>
<a class="sourceLine" id="cb70-7" title="7"><span class="kw">summary</span>(out)[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>]</a></code></pre></div>
<pre><code>##   name items passes fails nNA error warning
## 1   V1  1199   1170    29   0 FALSE   FALSE</code></pre>
<p>The function <code>contains_at_least</code> splits the <code>samplonomy</code> dataset into blocks
according to values of <code>region</code> and <code>measure</code>. Next, it checks that in each
block the variable <code>period</code> contains at least the values 2014–2019.</p>
<p>The return value is a logical vector where the number of elements equals the
number of rows in the dataset under scrutiny. It is <code>TRUE</code> for each block
where all years are present, and <code>FALSE</code> for each block where one of the
years is missing. In this case 29 records are labeled as FALSE. These
can be found as follows.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" title="1"><span class="kw">head</span>(<span class="kw">violating</span>(samplonomy, out))</a></code></pre></div>
<pre><code>##     region freq period measure  value
## 1    Agria    A   2014     gdp 600000
## 5    Agria    Q 2014Q1     gdp  60000
## 9    Agria    Q 2014Q2     gdp 120000
## 13   Agria    Q 2014Q3     gdp 300000
## 17   Agria    Q 2014Q4     gdp 120000
## 204  Agria    Q 2015Q1     gdp  58200</code></pre>
<p>Inspection of these records shows that in this block, for <code>Agria</code> the GDP
for <code>"2015"</code> is missing.</p>
<p>We can perform a stricter check, and test whether for each <code>measure</code>, all
quarters <code>"2014Q1"</code> <span class="math inline">\(\ldots\)</span> <code>"2019Q4"</code> are present for each province (<code>Agria</code>
and <code>Induston</code>). First create a key set to test against.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" title="1">years &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="dv">2014</span><span class="op">:</span><span class="dv">2019</span>)</a>
<a class="sourceLine" id="cb74-2" title="2">quarters &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Q&quot;</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb74-3" title="3"></a>
<a class="sourceLine" id="cb74-4" title="4">keyset &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb74-5" title="5">  <span class="dt">region =</span> <span class="kw">c</span>(<span class="st">&quot;Agria&quot;</span>, <span class="st">&quot;Induston&quot;</span>)</a>
<a class="sourceLine" id="cb74-6" title="6">  , <span class="dt">period =</span> <span class="kw">sapply</span>(years, paste0, quarters))</a>
<a class="sourceLine" id="cb74-7" title="7"></a>
<a class="sourceLine" id="cb74-8" title="8"><span class="kw">head</span>(keyset)</a></code></pre></div>
<pre><code>##     region period
## 1    Agria 2014Q1
## 2 Induston 2014Q1
## 3    Agria 2014Q2
## 4 Induston 2014Q2
## 5    Agria 2014Q3
## 6 Induston 2014Q3</code></pre>
<p>This key set will be referenced in the rule, and passed to <code>confront</code> as reference
data.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" title="1">rule &lt;-<span class="st"> </span><span class="kw">validator</span>(<span class="kw">contains_at_least</span>(<span class="dt">keys=</span>minimal_keys, <span class="dt">by=</span>measure))</a>
<a class="sourceLine" id="cb76-2" title="2">out &lt;-<span class="st"> </span><span class="kw">confront</span>(samplonomy, rule, <span class="dt">ref=</span><span class="kw">list</span>(<span class="dt">minimal_keys=</span>keyset))</a>
<a class="sourceLine" id="cb76-3" title="3"><span class="co"># showing 7 columns of output for readability</span></a>
<a class="sourceLine" id="cb76-4" title="4"><span class="kw">summary</span>(out)[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>]</a></code></pre></div>
<pre><code>##   name items passes fails nNA error warning
## 1   V1  1199    899   300   0 FALSE   FALSE</code></pre>
<p>There are 300 fails. Inspecting the data set as above, we
see that for Induston, the <code>export</code> is missing in <code>"2018Q3"</code>.</p>
<p>Finally, we do a strict test, to check that for each <code>measure</code> all periods and
all regions are reported. We also demand that there are no more and no less
records than for each individual measure. For this, the function
<code>contains_exactly</code> can be used.</p>
<p>First create a keyset.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" title="1">years &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="dv">2014</span><span class="op">:</span><span class="dv">2019</span>)</a>
<a class="sourceLine" id="cb78-2" title="2">quarters &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Q&quot;</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb78-3" title="3"></a>
<a class="sourceLine" id="cb78-4" title="4">keyset &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(</a>
<a class="sourceLine" id="cb78-5" title="5">  <span class="dt">region  =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb78-6" title="6">    <span class="st">&quot;Agria&quot;</span> </a>
<a class="sourceLine" id="cb78-7" title="7">   ,<span class="st">&quot;Crowdon&quot;</span></a>
<a class="sourceLine" id="cb78-8" title="8">   ,<span class="st">&quot;Greenham&quot;</span></a>
<a class="sourceLine" id="cb78-9" title="9">   ,<span class="st">&quot;Induston&quot;</span></a>
<a class="sourceLine" id="cb78-10" title="10">   ,<span class="st">&quot;Mudwater&quot;</span></a>
<a class="sourceLine" id="cb78-11" title="11">   ,<span class="st">&quot;Newbay&quot;</span></a>
<a class="sourceLine" id="cb78-12" title="12">   ,<span class="st">&quot;Oakdale&quot;</span></a>
<a class="sourceLine" id="cb78-13" title="13">   ,<span class="st">&quot;Samplonia&quot;</span></a>
<a class="sourceLine" id="cb78-14" title="14">   ,<span class="st">&quot;Smokeley&quot;</span></a>
<a class="sourceLine" id="cb78-15" title="15">   ,<span class="st">&quot;Wheaton&quot;</span></a>
<a class="sourceLine" id="cb78-16" title="16">  )</a>
<a class="sourceLine" id="cb78-17" title="17"> ,<span class="dt">period =</span> <span class="kw">c</span>(years, <span class="kw">sapply</span>(years, paste0, quarters))</a>
<a class="sourceLine" id="cb78-18" title="18">)</a>
<a class="sourceLine" id="cb78-19" title="19"><span class="kw">head</span>(keyset)</a></code></pre></div>
<pre><code>##     region period
## 1    Agria   2014
## 2  Crowdon   2014
## 3 Greenham   2014
## 4 Induston   2014
## 5 Mudwater   2014
## 6   Newbay   2014</code></pre>
<p>The keyset is passed as reference data to the rule using <code>confront</code>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" title="1">rule &lt;-<span class="st"> </span><span class="kw">validator</span>( <span class="kw">contains_exactly</span>(all_keys, <span class="dt">by=</span>measure) )</a>
<a class="sourceLine" id="cb80-2" title="2">out  &lt;-<span class="st"> </span><span class="kw">confront</span>(samplonomy, rule, <span class="dt">ref=</span><span class="kw">list</span>(<span class="dt">all_keys=</span>keyset))</a>
<a class="sourceLine" id="cb80-3" title="3"><span class="co"># showing 7 columns of output for readability</span></a>
<a class="sourceLine" id="cb80-4" title="4"><span class="kw">summary</span>(out)[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>]</a></code></pre></div>
<pre><code>##   name items passes fails nNA error warning
## 1   V1  1199      0  1199   0 FALSE   FALSE</code></pre>
<p>To find where the errors reside, we first select the records with an error and
then find the unique measures that occur in those records.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" title="1">erroneous_records &lt;-<span class="st"> </span><span class="kw">violating</span>(samplonomy, out)</a>
<a class="sourceLine" id="cb82-2" title="2"><span class="kw">unique</span>(erroneous_records<span class="op">$</span>measure)</a></code></pre></div>
<pre><code>## [1] &quot;gdp&quot;     &quot;import&quot;  &quot;export&quot;  &quot;balance&quot;</code></pre>
<p>So here, blocks containing GDP and Export have entire records missing.</p>
</div>
<div id="gaps-in-time-series" class="section level2">
<h2><span class="header-section-number">3.4</span> Gaps in (time) series</h2>
<p>For time series, or possibly other series it is desirable that
there is a constant distance between each two elements of the series.
The mathematical term for such a series is called a <em>linear sequence</em>.
Here are some examples of linear series.</p>
<ul>
<li>The natural numbers: <span class="math inline">\(1,2,3,\ldots\)</span></li>
<li>The even natural numbers <span class="math inline">\(2, 4, 6, \ldots\)</span></li>
<li>Quarters periods: <code>"2020Q1"</code>, <code>"2020Q2"</code>, <span class="math inline">\(\ldots\)</span></li>
<li>Years (these are just natural numbers): <span class="math inline">\(2019, 2020, \ldots\)</span></li>
</ul>
<p>The <code>validate</code> functions <code>is_linear_sequence</code> and <code>in_linear_sequence</code> check
whether a variable represents a linear series, possibly in blocks defined by
categorical variables. They can be used interactively or as a rule in a
validator object. We first demonstrate how these functions work, and then give
an example with the <code>samplonomy</code> dataset.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" title="1"><span class="kw">is_linear_sequence</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>))</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" title="1"><span class="kw">is_linear_sequence</span>(<span class="kw">c</span>(<span class="dv">8</span>,<span class="dv">6</span>,<span class="dv">4</span>,<span class="dv">2</span>))</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" title="1"><span class="kw">is_linear_sequence</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">16</span>))</a></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>For character data, the function is capable of recognizing certain formats
for time periods.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" title="1"><span class="kw">is_linear_sequence</span>(<span class="kw">c</span>(<span class="st">&quot;2020Q1&quot;</span>,<span class="st">&quot;2020Q2&quot;</span>,<span class="st">&quot;2020Q3&quot;</span>,<span class="st">&quot;2020Q4&quot;</span>))</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>See <code>?is_linear_sequence</code> for a full specification of supported
date-time formats.</p>
<p>It is not necessary for data to be sorted in order to be recognized as a
linear sequence.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" title="1"><span class="kw">is_linear_sequence</span>(<span class="kw">c</span>(<span class="st">&quot;2020Q4&quot;</span>,<span class="st">&quot;2020Q2&quot;</span>,<span class="st">&quot;2020Q3&quot;</span>,<span class="st">&quot;2020Q1&quot;</span>))</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>One can force a begin and/or end point for the sequence as well.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" title="1"><span class="kw">is_linear_sequence</span>(<span class="kw">c</span>(<span class="st">&quot;2020Q4&quot;</span>,<span class="st">&quot;2020Q2&quot;</span>,<span class="st">&quot;2020Q3&quot;</span>,<span class="st">&quot;2020Q1&quot;</span>), <span class="dt">begin=</span><span class="st">&quot;2020Q2&quot;</span>)</a></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>Finally it is possible to split a variable by one or more other columns and
check whether each block represents a linear sequence.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" title="1">series &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb96-2" title="2">blocks &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>,<span class="st">&quot;b&quot;</span>),<span class="dt">each=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb96-3" title="3"><span class="kw">is_linear_sequence</span>(series, <span class="dt">by=</span>blocks)</a></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>Now, this result is not very useful since now it is unknown which block
is not a linear series. This is where the function <code>in_linear_series</code> comes in.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" title="1"><span class="kw">in_linear_sequence</span>(series, <span class="dt">by=</span>blocks)</a></code></pre></div>
<pre><code>## [1]  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE</code></pre>
<p>There are some subtleties. A single element is also a linear sequence (of length 1).</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" title="1"><span class="kw">is_linear_sequence</span>(<span class="dv">5</span>)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>This can yield surprises in cases of blocks of length 1.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" title="1">blocks[<span class="dv">8</span>] &lt;-<span class="st"> &quot;c&quot;</span></a>
<a class="sourceLine" id="cb102-2" title="2"><span class="kw">data.frame</span>(<span class="dt">series=</span>series, <span class="dt">blocks=</span>blocks)</a></code></pre></div>
<pre><code>##   series blocks
## 1      1      a
## 2      2      a
## 3      3      a
## 4      4      a
## 5      1      b
## 6      2      b
## 7      3      b
## 8      3      c</code></pre>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" title="1"><span class="kw">in_linear_sequence</span>(series, blocks)</a></code></pre></div>
<pre><code>## [1] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE</code></pre>
<p>We now have three linear series, namely</p>
<ul>
<li>For <code>"a"</code>: <code>1,2,3,4</code></li>
<li>For <code>"b"</code>: <code>1,2,3</code></li>
<li>For <code>"c"</code>: <code>3</code>.</li>
</ul>
<p>We can circumvent this by giving explicit bounds.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb106-1" title="1"><span class="kw">in_linear_sequence</span>(series, blocks, <span class="dt">begin=</span><span class="dv">1</span>, <span class="dt">end=</span><span class="dv">4</span>)</a></code></pre></div>
<pre><code>## [1]  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE</code></pre>
<p>We now return to the <code>samplonomy</code> dataset. We wish to check that for
each measure and each area, the time series are linear series. Since there
are time series of different frequencies, we need to split the data by frequency
as well.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb108-1" title="1">rule &lt;-<span class="st"> </span><span class="kw">validator</span>(<span class="kw">in_linear_sequence</span>(period, <span class="dt">by=</span><span class="kw">list</span>(region, freq, measure)))</a>
<a class="sourceLine" id="cb108-2" title="2">out  &lt;-<span class="st"> </span><span class="kw">confront</span>(samplonomy, rule)</a>
<a class="sourceLine" id="cb108-3" title="3"><span class="kw">summary</span>(out)[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>]</a></code></pre></div>
<pre><code>##   name items passes fails nNA error warning
## 1   V1  1199   1170    29   0 FALSE   FALSE</code></pre>
<p>We can find the blocks where records are not in sequence as follows (output not
printed here for brevity).</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb110-1" title="1"><span class="kw">violating</span>(samplonomy, out)</a></code></pre></div>
<p>Inspection of the selected records shows that for Agria the GDP for 2015 is
missing, and that for Induston the Export for 2018Q3 is missing while Export
for 2018Q2 occurs twice (but with different values)</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="sect-varlevelchecks.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="multivariate-checks.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["validatecookbook.pdf", "validatecookbook.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
